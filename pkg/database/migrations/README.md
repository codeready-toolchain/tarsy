# Database Migrations

SQL migrations generated by [Atlas CLI](https://atlasgo.io/), applied at runtime by [golang-migrate](https://github.com/golang-migrate/migrate).

## How It Works

1. **Source of truth**: Ent schemas in `ent/schema/*.go`.
2. **Atlas diffs**: `atlas migrate diff` compares this migration directory against the Ent schema and writes a new `.up.sql` file.
3. **Embedded at build**: `.sql` files are embedded into the Go binary via `go:embed`.
4. **Applied on startup**: `runMigrations()` in `pkg/database/client.go` applies pending migrations automatically.
5. **GIN indexes**: Created separately by `CreateGINIndexes()` in `pkg/database/migrations.go` (Atlas can't manage custom SQL indexes).

## Adding a New Migration

### Prerequisites

- [Atlas CLI](https://atlasgo.io/getting-started#installation): `curl -sSf https://atlasgo.sh | sh`
- PostgreSQL running: `make db-start`

### Steps

```bash
# 1. Edit ent/schema/*.go with your changes

# 2. Regenerate Ent code
make ent-generate

# 3. Ensure PostgreSQL is running
make db-start

# 4. Generate the migration (uses a temporary DB -- your dev data is safe)
make migrate-create NAME=describe_your_change

# 5. Review the generated .up.sql file in pkg/database/migrations/

# 6. Verify
go build ./...

# 7. Commit the .up.sql file and atlas.sum
```

## Troubleshooting

### "checksum file not found"

The `atlas.sum` file is missing or out of sync. Regenerate it:

```bash
make migrate-hash
```

## Important Notes

- **Forward-only**: No `.down.sql` files. To undo a change, create a new migration that reverses it.
- **Enums are VARCHAR**: Adding new enum values in Ent doesn't need a migration -- just `make ent-generate`. Validation is at the app level.
- **Don't edit existing migrations**: Treat applied migrations as immutable.
- **atlas.sum must stay in sync**: If you manually edit a migration, run `make migrate-hash`.

## Available Make Targets

| Target | Description |
|---|---|
| `make migrate-create NAME=...` | Generate a new migration from Ent schema diff (uses temporary DB) |
| `make migrate-hash` | Regenerate `atlas.sum` checksum file |
| `make ent-generate` | Regenerate Ent Go code from schemas |
| `make db-start` | Start PostgreSQL container |
| `make db-reset` | Drop and recreate the dev database (terminates active connections) |
